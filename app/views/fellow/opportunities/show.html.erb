<h1><%= @candidate.opportunity.formatted_name %></h1>

<table class="opportunity-stages">
  <thead>
    <th class="phase">Phase</th>
    <th class="recommended-action">Recommended Action</th>
  </thead>
  
  <tbody>
    <% completion = 'completed' %>

    <% ['Apply', 'Interview', 'Offer'].each do |phase| %>
      <% phase_content = @content.select{|k,v| v['phase'] == phase} %>

      <% phase_content.each do |stage_name, content| %>
        <tr>
          <% if content['phase_position'].to_i == 1 %>
            <td class="phase phase-<%= phase.downcase %>" rowspan="<%= phase_content.size %>"><h2><%= phase %></h2></td>
          <% end %>

          <% if stage_name == @candidate.stage # Active Stage %>
            <% completion = 'not-completed' %> 

            <td class="stage active-stage phase-<%= phase.downcase %>">
              <h3><%= content['phase_position'] %>. <%= content['title'] %></h3>
      
              <% if content['links'] %>
                <h4 class="question"><%= interpolate(content['question']) %></h4>     
                <ul class="response-links">
                  <% content['links'].each do |update, label| %>
                    <li><%= link_to_status_update update, label %></li>
                  <% end %>
                </ul>
              <% end %>
          
              <% if content['tips'] %>
                <h4 class="tips-toggle">How to do this like a pro</h4>
                <div class="tips">
                  <% if content['tips']['header'] %>
                    <p><%= interpolate(content['tips']['header']) %></p>
                  <% end %>
                  <% if content['tips']['list'] %>
                    <ul>
                      <% content['tips']['list'].each do |tip| %>
                        <li><%= interpolate(tip) %></li>
                      <% end %>
                    </ul>
                  <% end %>
                </div>
              <% end %>
            </td>

          <% else # Not the active Stage %>
            <td class="stage <%= completion %> phase-<%= phase.downcase %>"><h3><%= content['phase_position'] %>. <%= content['title'] %></h3></td>
          <% end %>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>
